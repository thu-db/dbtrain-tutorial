
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>测试说明 · dbs-tutorial</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.7.5">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-click-reveal/click_reveal.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-codeblock-label/block.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-intopic-toc/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-katex-pro/katex.min.css">
                
            
                
                <link rel="stylesheet" href="gitbook/honkit-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/honkit-plugin-todo/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="intro.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">总述</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    实验框架
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2" data-path="test.html">
            
                <a href="test.html">
            
                    
                    测试说明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="intro.html">
            
                <a href="intro.html">
            
                    
                    实验说明
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">实验</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="lab1.html">
            
                <a href="lab1.html">
            
                    
                    lab 1: 记录管理
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">常见问题</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="faq.html">
            
                <a href="faq.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >测试说明</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <html><head></head><body><h1 id="测试说明">测试说明</h1>
<h2 id="环境配置">环境配置</h2>
<p>本实验依赖 cmake, make, g++ 构建工具，其中 g++ 需要支持 C++17 标准，编译解析器需要 flex 和 bison 工具，需先在本地环境安装这些依赖。</p>
<p>由于实验框架底层文件操作调用了 Unix 相关接口，故不支持 Windows 环境，Windows 用户建议使用 WSL，或使用 Virtualbox 或 VMWare 开一个 Ubuntu 虚拟机，然后参考下面的 Ubuntu 环境配置。</p>
<h3 id="ubuntu-环境配置">Ubuntu 环境配置</h3>
<p>建议使用 Ubuntu 22.04 及更高版本，使用 apt 安装依赖：</p>
<pre><code class="lang-bash">sudo apt install cmake make flex bison g++
</code></pre>
<h3 id="macos-环境配置">macOS 环境配置</h3>
<p>使用 homebrew 安装依赖：</p>
<pre><code class="lang-bash">brew install cmake flex bison
</code></pre>
<h3 id="测试是否配置好了环境">测试是否配置好了环境</h3>
<pre><code class="lang-bash">g++ -v
flex --version
bison --version
cmake --version
</code></pre>
<h2 id="运行实验框架">运行实验框架</h2>
<p>配好环境后，按照以下步骤进行操作：</p>
<h3 id="拉取实验仓库并重命名">拉取实验仓库并重命名</h3>
<p>使用 git clone 和 mv 命令（将 20xxxxxxxx 替换为你的学号）：</p>
<pre><code class="lang-bash">git <span class="hljs-built_in">clone</span> git@git.tsinghua.edu.cn:dbtrain/2023/dbtrain-20xxxxxxx.git
mv dbtrain-20xxxxxxx dbtrain-lab
</code></pre>
<p>仓库重命名操作是必须的，否则测试脚本无法正常工作。</p>
<h3 id="拉取测试仓库">拉取测试仓库</h3>
<p>在<strong>同一文件夹</strong>下，使用 git clone 命令拉取测试仓库。</p>
<pre><code class="lang-bash">git <span class="hljs-built_in">clone</span> git@git.tsinghua.edu.cn:dbtrain/dbtrain-lab-test.git
</code></pre>
<p>测试仓库应与实验仓库在同一父文件夹下，目录结构应为：</p>
<pre><code>&lt;diretory&gt;
├── dbtrain-lab
│   ├── src
│   ├── CMakeLists.txt
│   ├── .gitlab-ci.yml
│   ├── ...
├── dbtrain-lab-test
│   ├── lab1
│   ├── check.py
│   ├── ...
└── ...
</code></pre><p>新一次实验发布时，测试仓库可能会更新，开始新实验前请先通过<code>git pull</code>命令更新测试仓库。</p>
<h3 id="编译实验框架">编译实验框架</h3>
<p>进入 <code>dbtrain-lab</code> 目录，运行如下命令进行编译：</p>
<pre><code class="lang-bash"><span class="hljs-built_in">cd</span> dbtrain-lab
mkdir build &amp;&amp; <span class="hljs-built_in">cd</span> build
cmake ..
make -j4
</code></pre>
<p>或使用写好的编译脚本文件：</p>
<pre><code class="lang-bash">./build.sh
</code></pre>
<p>由于实验框架中部分函数需要同学们自己实现，所以编译过程中出现 <code>non-void function does not return a value [-Wreturn-type]</code> 或 <code>no return statement in function returning non-void [-Wreturn-type]</code> 的 warning 是正常的。</p>
<p>如果环境配置没有问题，应成功编译出可执行程序 <code>cli</code> ：</p>
<pre><code>...
[ 94%] Linking CXX static library ../lib/libthdb.a
[ 94%] Built target thdb
Scanning dependencies of target cli
[ 97%] Building CXX object src/CMakeFiles/cli.dir/cli.cpp.o
[100%] Linking CXX executable ../bin/cli
[100%] Built target cli
</code></pre><p>运行 <code>./bin/cli</code> 即可进入数据库交互界面：</p>
<pre><code>./bin/cli
dbtrain&gt; show databases;
+----------+
| Database |
+----------+

dbtrain&gt; create database test;
+---------+
| SUCCESS |
+---------+

dbtrain&gt; show databases;
+----------+
| Database |
+----------+
| test     |
+----------+
(1 rows)

dbtrain&gt;
</code></pre><p>通过 ctrl+c 或 ctrl+d 即可退出数据库交互界面。</p>
<p>数据库交互程序支持 <code>-s</code> 参数，该参数用于控制结果打印格式，加上该参数后将只打印必要字段，不打印表格框：</p>
<pre><code>./bin/cli -s
dbtrain&gt; use test;
SUCCESS

dbtrain&gt; create table t(id int, name char(4), score float);
SUCCESS

dbtrain&gt; desc t;
Name | Type | Length
id | INT | 4
name | STRING | 4
score | FLOAT | 8
</code></pre><p>该参数主要用于测试脚本进行结果比对，你在本地与数据库交互时无需使用该参数。</p>
<h2 id="测试脚本使用方法">测试脚本使用方法</h2>
<p>测试仓库目录结构如下：</p>
<pre><code>dbtrain-lab-test
├── README.md
├── check.py
├── lab1
│   ├── result
│   │   ├── 00_setup.result
│   │   ├── 10_basic.result
│   │   ├── 20_error.result
│   │   ├── 30_long_text.result
│   │   └── 40_many_rows.result
│   └── test
│       ├── 00_setup.sql
│       ├── 10_basic.sql
│       ├── 20_error.sql
│       ├── 30_long_text.sql
│       └── 40_many_rows.sql
└── test.sh
</code></pre><p><code>test.sh</code>是为 CI 准备的脚本，本地测试不会用到它。</p>
<p><code>check.py</code> 为测试脚本，在第 n 次实验中，该脚本会通过 <code>../dbtrain-lab/build/bin/cli -s</code> 命令运行数据库，枚举 lab{1..n}/test 目录下的所有文件，将这些文件按照序号从小到大的顺序依次输入数据库。同时脚本会在 labx 文件夹下建立 tmp 文件夹，将数据库的标准输出重定向到 tmp 文件夹下的文件中，最后将 tmp 文件夹的文件与 result 文件夹的文件内容进行对比，文件内容一致即通过测试。</p>
<p>由于标准错误 stderr 不会被重定向到文件中，因此你可以在实验代码中使用 cerr 输出调试信息，cerr 输出的信息不会影响测试结果。</p>
<p>你可以通过 <code>-l</code> 或 <code>--lab</code> 参数控制脚本进行前几次 lab 的测试，如 <code>python3 check.py -l 3</code> 则会运行 lab1, lab2 和 lab3 的测试。</p>
<p>脚本默认会运行 test 目录下相应 lab 的所有文件，你可以通过 <code>-u</code> 或 <code>--until</code> 参数控制最后一次 lab 中脚本运行的文件，如 <code>python3 check.py -l 2 -u 10</code> 将只会运行 lab 2 的 00 和 10 两个测试文件（以及 lab 1 的所有测试文件）。</p>
<h3 id="result-文件格式说明">result 文件格式说明</h3>
<p>result 文件的每个结果对应 sql 文件中一条 SQL 的期望输出，两个结果之间用一个空行隔开，一个典型的结果格式如下：</p>
<pre><code>-- 10.show tables;
Tables
t_basic
t_basic_2
</code></pre><p>第一行表示当前运行的是第几条 SQL 及对应的 SQL 语句，仅用于增加文件可读性，测试脚本比对结果时会去掉该行。</p>
<p>接下来的几行表示期望输出结果，SQL 对输出结果顺序没有要求，脚本会先将结果排序后再进行比对，因此如果你的数据库输出如下：</p>
<pre><code>Tables
t_basic_2
t_basic
</code></pre><p>也可以通过该条测试。</p>
<h3 id="测试脚本输出">测试脚本输出</h3>
<p>测试通过时，脚本会输出：</p>
<pre><code>Test 00_setup PASSED
Test 10_basic PASSED
Test 20_error PASSED
Test 30_long_text PASSED
Test 40_many_rows PASSED
5 / 5 cases PASSED
</code></pre><p>测试失败分为如下几种情况：</p>
<p>1.结果数目错误：</p>
<pre><code>Incorrect number of results
Expected:
26
Got:
23
Test 00_setup FAILED
</code></pre><p>测试 00_setup 中共 25 条 SQL，期望输出 26 个结果（包括退出数据库时输出的 Bye），但实际只输出了 23 个结果，可查看是否有某些 SQL 运行失败导致没有输出结果。</p>
<p>2.结果行数错误：</p>
<pre><code>SQL 20
Incorrect length
Expected:
3
Got:
1
Test 30_long_text FAILED
</code></pre><p>测试 30_long_text 的第 20 条 SQL 期望输出 3 行，实际输出 1 行。</p>
<p>3.结果错误：</p>
<pre><code>SQL 14
Incorrect result
Expected:
age | INT | 4
Got:
age | INT | 12884901892
Test 00_setup FAILED
</code></pre><p>测试 00_setup 的第 14 条 SQL 输出结果与期望输出不一致，可在 result 文件中查看第 14 条 SQL 及对应输出。</p>
<p>4.异常退出：</p>
<pre><code>Traceback (most recent call last):
  File &quot;check.py&quot;, line 105, in main
    if test_case.check():
  File &quot;check.py&quot;, line 46, in check
    tmp_results = tmp_result_file.read().splitlines()
  File &quot;/usr/lib/python3.8/codecs.py&quot;, line 322, in decode
    (result, consumed) = self._buffer_decode(data, self.errors, final)
UnicodeDecodeError: &apos;utf-8&apos; codec can&apos;t decode byte 0x96 in position 347: invalid start byte
Test 40_many_rows FAILED
</code></pre><p>脚本运行错误，具体原因需根据报错信息推测，本示例中是由于输出文本中包含异常字符导致运行错误。</p>
</body></html>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: 实验框架">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="intro.html" class="navigation navigation-next " aria-label="Next page: 实验说明">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"测试说明","level":"1.2","depth":1,"next":{"title":"实验说明","level":"1.3","depth":1,"path":"intro.md","ref":"intro.md","articles":[]},"previous":{"title":"实验框架","level":"1.1","depth":1,"path":"README.md","ref":"README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["alerts","back-to-top-button","chapter-fold","click-reveal","code","codeblock-label","expandable-chapters-interactive","hide-element","intopic-toc","katex-pro","search-plus","todo"],"root":"./docs","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"intopic-toc":{"selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4, .markdown-section h5, .markdown-section h6","mode":"nested","maxDepth":6,"isCollapsed":true,"isScrollspyActive":true,"visible":true,"label":"目录"},"todo":{},"codeblock-label":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"katex-pro":{},"fontsettings":{"theme":"white","family":"sans","size":2},"click-reveal":{},"highlight":{},"expandable-chapters-interactive":{},"back-to-top-button":{},"alerts":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"dbs-tutorial","gitbook":"*"},"file":{"path":"test.md","mtime":"2023-03-16T13:44:20.017Z","type":"markdown"},"gitbook":{"version":"3.7.5","time":"2023-03-16T13:44:31.964Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-click-reveal/click_reveal.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-interactive/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/anchor.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/gumshoe.polyfills.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-intopic-toc/plugin.js"></script>
        
    
        
        <script src="gitbook/honkit-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/honkit-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>


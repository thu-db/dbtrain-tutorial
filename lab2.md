# LAB 2 记录管理实验文档

## 实验概述

本次实验主要关注于数据库系统的日志记录及故障恢复功能，希望同学们通过本次实验能够更好地理解数据库日志的记录方式以及日志对于故障恢复过程的作用。重点关注于简化的ARIES算法的实现，以及日志记录和管理的方式。

## 实验任务

本次实验主要有3个任务：
1. 阅读新增的代码，理解日志记录的过程。
2. 补全未完成的日志设计：Update日志镜像的部分函数以及Checkpoint日志的部分函数。
3. 完成简化的ARIES算法：本次实验下仅要求支持单线程场景。

## 相关模块

1. tx 模块：事务管理模块，负责事务ID的管理，维护线程ID与事务的XID的对应关系。本次实验中**不需要重点关注**。
2. log 模块：日志管理模块，负责处理日志记录以及故障恢复功能。是本次实验需要重点关注的部分，尤其是LogManager模块中包含了本次实验的绝大部分内容。
3. table 模块：在LAB 1代码基础上添加记录WAL日志得到过程。

## 基础功能实现顺序

1. log/checkpoint_log.cpp: Checkpoint日志的设计，与其他日志不同之处在于，Checkpoint日志在Load过程中需要将数据更新到LogManager的成员变量，完成加载过程。
2. table/table.cpp: 在LAB 1代码基础上添加记录WAL日志得到过程。
3. log/manager_log.cpp: 首先完成3中基本操作(INSERT/DELETE/UPDATE)的日志记录过程。
4. log/log_image.cpp: Update日志镜像的设计，实现物理逻辑日志的序列化和反序列化
5. update/update_log.cpp: 基于日志镜像完成Redo和Undo的具体操作。
6. log/manager_log.cpp: 完成故障恢复算法，实现Analyse，Redo，Undo三个函数。

## 基本测试限制

本次实验中，基本测试为简单的测试样例，没有包含复杂的故障恢复场景，仅考虑完成基本功能的同学不需要考虑如下场景：
1. 日志在Undo或Redo过程会影响TableMeta对应的操作
2. 日志在Undo或Redo过程会影响PageHeader.next_free的操作
3. 插入导致新的页面分配后出现故障，导致Redo过程中页面缺失的场景
4. 更多复杂的特殊场景

本次实验的基本测试具有一定局限性，主要是为了考虑同学们工作量进行了简化。但是希望同学们能发掘更多的场景，探索在这些场景下恢复算法的应对策略。这也是本次实验高级功能的一个选择。


## 可选高级功能

不要求将高级功能集成到主分支中，建议单开分支完成实验。但是建议同学们设计验证自己实验结果的测例并给出测试的可视化结果展示。

1. 复杂的日志恢复场景(Max 2)：给出能够适应复杂场景的日志恢复算法（有额外测例对应于基本测例限制（1）-（3），价值1）
2. 无中断的Checkpoint日志记录(Max 1)：需要拆分Checkpoint日志，需要自行添加额外测例
3. Undo过程中系统异常的恢复(Max 1)：此处需要添加CLR日志，需要自行添加额外测例
4. 日志缓存(Max 1)：添加日志缓存机制，同时修改现有的数据缓存替换算法，利用FlushedLSN限制可写回的数据页面，需要自行添加额外测例

同时也鼓励同学们结合相关课程内容提出自己的创新设计。实验框架对于本次实验的几个高级功能有相对良好的支持，各个高级功能都比较容易完整实现，所以同学们可以选择同时支持多个高级功能来实现更为完整的基于日志的故障恢复算法。